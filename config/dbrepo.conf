# This is required to proxy Grafana Live WebSocket connections.
map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

client_max_body_size 20G;

resolver 127.0.0.11 valid=30s; # docker dns

upstream auth {
    server auth-service:8080;
}

upstream broker {
    server broker-service:15672;
}

upstream analyse {
    server analyse-service:8080;
}

upstream data {
    server data-service:8080;
}

upstream metadata {
    server metadata-service:8080;
}

upstream search {
    server search-service:8080;
}

upstream ui {
    server ui:3000;
}

upstream upload {
    server upload-service:8080;
}

upstream dashboard-service {
    server dashboard-service:3000;
}

server {
    listen 80 default_server;
    server_name _;

    location /dashboard/ {
        rewrite  ^/dashboard/(.*)  /$1 break;
        proxy_set_header           Host $host;
        proxy_set_header           X-Real-IP $remote_addr;
        proxy_set_header           X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header           X-Forwarded-Proto $scheme;
        proxy_pass                 http://dashboard-service;
        proxy_read_timeout         90;
    }

    # Proxy Grafana Live WebSocket connections.
    location /dashboard/api/live/ {
        rewrite  ^/dashboard/(.*)  /$1 break;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_pass http://dashboard-service;
    }

    location /api/search {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://search;
        proxy_read_timeout      90;
    }

    location /api/broker {
        rewrite /api/broker/(.*) /api/$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://broker;
        proxy_read_timeout      90;
    }

    location /api/upload {
#         allow 128.130.0.0/16;
#         deny all;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_set_header        X-Forwarded-Host $host;
        proxy_pass              http://upload;
        proxy_read_timeout      90;
        # Disable request and response buffering
        proxy_request_buffering off;
        proxy_buffering         off;
        proxy_http_version      1.1;
    }

    location /api/analyse {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://analyse;
        proxy_read_timeout      90;
    }

    location /api/auth {
        rewrite /api/auth/(.*) /$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://auth;
        proxy_read_timeout      90;
    }

    location ~ /api/database/([0-9]+)/table/([0-9]+)/(data|history|export|statistic) {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://data;
        proxy_read_timeout      90;
    }

    location ~ /api/database/([0-9]+)/view/([0-9]+)/data {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://data;
        proxy_read_timeout      90;
    }

    location ~ /api/database/([0-9]+)/view {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://metadata;
        proxy_read_timeout      90;
    }

    location ~ /api/database/([0-9]+)/subset {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://data;
        proxy_read_timeout      600;
    }

    location ~ /api/(database|concept|container|identifier|image|message|license|oai|ontology|unit|user) {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://metadata;
        proxy_read_timeout      90;
    }

    location ~ /pid/([0-9]+) {
        rewrite /pid/(.*) /api/identifier/$1 break;
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://metadata;
        proxy_read_timeout      90;
    }

    location / {
        proxy_set_header        Host $host;
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        X-Forwarded-Proto $scheme;
        proxy_pass              http://ui;
        proxy_read_timeout      90;
    }
}
